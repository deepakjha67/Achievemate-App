<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>Achieve-mate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-body: #0f172a; --bg-card: #1e293b; --bg-card-hover: #334155; --primary: #6366f1; --accent: #fbbf24; --success: #10b981; --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155; --radius-lg: 16px; --font-main: 'Inter', sans-serif; --font-heading: 'Poppins', sans-serif; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-main); line-height: 1.6; padding-bottom: 80px; }
        
        /* UTILS */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem; }
        .card-title { font-family: var(--font-heading); font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .btn { border: none; outline: none; cursor: pointer; border-radius: 12px; padding: 0.75rem 1.5rem; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: transform 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--bg-card-hover); color: var(--text-main); border: 1px solid var(--border); }
        .btn-icon-only { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: transparent; color: var(--text-muted); border: none; }
        
        /* INPUTS */
        input, select, textarea { width: 100%; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); padding: 0.8rem; border-radius: 12px; font-size: 16px; margin-bottom: 10px; }
        
        /* HEADER */
        .page-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 1.5rem 0 1.5rem; margin-bottom: 1.5rem; }
        .greeting h1 { font-family: var(--font-heading); font-size: 1.5rem; line-height: 1.2; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .streak-badge { background: rgba(251, 191, 36, 0.1); padding: 5px 12px; border-radius: 20px; color: var(--accent); font-weight: bold; border: 1px solid rgba(251, 191, 36, 0.2); }
        
        /* NAVIGATION */
        .mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-top: 1px solid var(--border); height: 70px; display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); font-size: 0.7rem; gap: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.4rem; }

        /* DASHBOARD SPECIFIC */
        .level-card { background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid var(--primary); color: white; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }
        
        .priority-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-body); border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border); }
        .priority-item.checked .text { text-decoration: line-through; color: var(--text-muted); opacity: 0.7; }
        .checkbox { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-muted); display: flex; align-items: center; justify-content: center; color: white; }
        .priority-item.checked .checkbox { background: var(--success); border-color: var(--success); }

        /* GRAPH */
        .graph-container { display: flex; justify-content: space-between; align-items: flex-end; height: 150px; padding: 10px; }
        .graph-bar-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; height: 100%; justify-content: flex-end; flex: 1; }
        .graph-bar { width: 8px; background: var(--primary); border-radius: 4px; min-height: 4px; opacity: 0.7; }
        .graph-day { font-size: 0.6rem; color: var(--text-muted); }

        /* COURSES */
        .course-card { overflow: hidden; }
        .course-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .course-progress { height: 4px; background: var(--bg-body); border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .course-fill { height: 100%; background: var(--success); width: 0%; }
        .video-list { display: none; margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px; }
        .video-list.open { display: block; }

        /* CALENDAR (Profile) */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 10px; }
        .cal-day { font-size: 0.8rem; padding: 8px; border-radius: 8px; color: var(--text-muted); position: relative; }
        .cal-day.active { background: rgba(99, 102, 241, 0.2); color: white; font-weight: bold; border: 1px solid var(--primary); }
        .cal-dot { width: 4px; height: 4px; background: var(--success); border-radius: 50%; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); }

        /* BADGES */
        .ach-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .ach-item { background: var(--bg-body); padding: 10px; border-radius: 12px; text-align: center; opacity: 0.4; border: 1px solid transparent; }
        .ach-item.unlocked { opacity: 1; border-color: var(--accent); background: rgba(251, 191, 36, 0.05); }
        .ach-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .ach-name { font-size: 0.7rem; font-weight: bold; }

        /* MODALS & OVERLAYS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .overlay.active { display: flex; }
        .modal { background: var(--bg-card); width: 100%; max-width: 400px; border-radius: 20px; padding: 2rem; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        /* FOCUS MODE */
        #focus-timer-display { font-size: 4rem; font-weight: bold; font-family: monospace; color: var(--primary); margin: 20px 0; }
        
        /* Helper to hide views */
        .view-section { display: none; padding: 0 1.5rem; }
        .view-section.active { display: block; }
    </style>
</head>
<body>

    <div id="toast" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#334155; color:white; padding:10px 20px; border-radius:50px; z-index:9999; display:none; font-size:0.9rem;">Notification</div>

    <div id="welcome-modal" class="overlay">
        <div class="modal" style="text-align:center;">
            <h2 style="color:var(--primary); margin-bottom:10px;">Welcome to Achieve-Mate!</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">Your personal growth companion. Track goals, courses, and focus time.</p>
            <div style="text-align:left; margin-bottom:20px; font-size:0.9rem; color:#ccc;">
                <p>‚úÖ Daily Goals</p>
                <p>üìö Course Tracking</p>
                <p>üî• Consistency Streaks</p>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="closeWelcome()">Let's Start!</button>
        </div>
    </div>

    <div id="auth-modal" class="overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>Login</h2>
                <button class="btn-icon-only" onclick="toggleAuth(false)">‚úï</button>
            </div>
            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-password" placeholder="Password">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-primary" style="flex:1" onclick="handleLogin()">Login</button>
                <button class="btn btn-secondary" style="flex:1" onclick="handleSignup()">Sign Up</button>
            </div>
        </div>
    </div>

    <div id="course-modal" class="overlay">
        <div class="modal">
            <h3>Add New Course</h3>
            <input type="text" id="c-name" placeholder="Course Name (e.g. Python A-Z)">
            <select id="c-source"><option>Udemy</option><option>YouTube</option><option>Coursera</option></select>
            <textarea id="c-videos" rows="5" placeholder="Paste video titles (one per line)"></textarea>
            <button class="btn btn-primary" style="width:100%" onclick="saveCourse()">Save Course</button>
            <button class="btn btn-secondary" style="width:100%; margin-top:10px;" onclick="document.getElementById('course-modal').classList.remove('active')">Cancel</button>
        </div>
    </div>

    <div id="focus-overlay" class="overlay" style="background:#0f172a;">
        <div style="text-align:center; width:100%;">
            <h2 style="color:var(--text-muted);">Focusing on</h2>
            <h1 id="focus-task-name" style="font-size:2rem; margin-bottom:20px;">Deep Work</h1>
            <div id="focus-timer-display">25:00</div>
            <button class="btn btn-danger" onclick="stopFocus()">Stop Session</button>
        </div>
    </div>

    <header class="page-header">
        <div class="greeting">
            <h1 id="greet-text">Good Morning!</h1>
            <p id="date-text" style="font-size:0.9rem; color:var(--text-muted);">...</p>
        </div>
        <div class="header-right">
            <button id="btn-login" class="btn btn-primary" style="padding:0.5rem 1rem; font-size:0.8rem;" onclick="toggleAuth(true)">Login</button>
            <div id="user-badge" style="display:none; width:35px; height:35px; background:var(--primary); border-radius:50%; align-items:center; justify-content:center; font-weight:bold;">U</div>
            <div class="streak-badge">üî• <span id="streak-display">0</span></div>
        </div>
    </header>

    <div id="view-home" class="view-section active">
        <div class="card level-card">
            <div style="display:flex; justify-content:space-between;">
                <div>
                    <div style="font-size:0.8rem; opacity:0.8;">CURRENT LEVEL</div>
                    <div style="font-size:2.5rem; font-weight:bold; line-height:1;" id="lvl-num">1</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold;" id="xp-num">0 XP</div>
                    <div style="font-size:0.7rem; opacity:0.8;">Keep going!</div>
                </div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="lvl-bar"></div></div>
        </div>

        <div class="card">
            <div class="card-title">Today's Goals <button class="btn-icon-only" onclick="addGoal()">+</button></div>
            <input type="text" id="goal-input" placeholder="Add a task..." onkeypress="if(event.key==='Enter') addGoal()">
            <div id="goals-list"></div>
        </div>

        <div class="card">
            <div class="card-title">Consistency</div>
            <div class="graph-container" id="consistency-graph"></div>
        </div>
    </div>

    <div id="view-courses" class="view-section">
        <div class="card">
            <div class="card-title">My Courses <button class="btn btn-primary" style="padding:5px 10px; font-size:0.8rem;" onclick="document.getElementById('course-modal').classList.add('active')">+ Add</button></div>
            <div id="courses-list"></div>
        </div>
    </div>

    <div id="view-focus" class="view-section">
        <div class="card" style="text-align:center; padding:3rem 1rem;">
            <div style="font-size:4rem; color:var(--primary); margin-bottom:1rem;"><i class="fas fa-clock"></i></div>
            <h2>Focus Session</h2>
            <p style="color:var(--text-muted); margin-bottom:2rem;">Stay distracted free.</p>
            <input type="text" id="focus-input" placeholder="What are you working on?" style="text-align:center;">
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                <button class="btn btn-secondary" onclick="setFocusTime(25)">25m</button>
                <button class="btn btn-secondary" onclick="setFocusTime(45)">45m</button>
                <button class="btn btn-secondary" onclick="setFocusTime(60)">60m</button>
            </div>
            <button class="btn btn-primary" style="width:100%; padding:1rem;" onclick="startFocus()">Start Focus</button>
        </div>
        <div class="card">
            <div class="card-title">Recent Sessions</div>
            <div id="focus-logs" style="font-size:0.9rem; color:var(--text-muted);">No sessions yet.</div>
        </div>
    </div>

    <div id="view-awards" class="view-section">
        <div class="card">
            <div class="card-title">Badges & Milestones <span id="badge-count" style="font-size:0.9rem; color:var(--accent);">0/17</span></div>
            <div class="ach-grid" id="badges-grid"></div>
        </div>
    </div>

    <div id="view-profile" class="view-section">
        <div class="card" style="display:flex; align-items:center; gap:15px;">
            <div style="width:60px; height:60px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; font-weight:bold; color:white;" id="p-avatar">G</div>
            <div>
                <h2 id="p-name" style="font-size:1.2rem; margin:0;">Guest User</h2>
                <p id="p-email" style="font-size:0.8rem; color:var(--text-muted);">Not logged in</p>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Activity Calendar</div>
            <div class="cal-grid" id="calendar-grid"></div>
        </div>

        <div class="card">
            <div class="card-title">Settings</div>
            <button class="btn btn-secondary" style="width:100%; margin-bottom:10px;" onclick="resetData()">Reset All Data</button>
            <button class="btn btn-danger" id="btn-logout" style="width:100%; display:none;" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <nav class="mobile-nav">
        <div class="nav-item active" onclick="switchTab('home', this)"><i class="fas fa-home"></i><span>Home</span></div>
        <div class="nav-item" onclick="switchTab('courses', this)"><i class="fas fa-book"></i><span>Courses</span></div>
        <div class="nav-item" onclick="switchTab('focus', this)"><i class="fas fa-clock"></i><span>Focus</span></div>
        <div class="nav-item" onclick="switchTab('awards', this)"><i class="fas fa-trophy"></i><span>Awards</span></div>
        <div class="nav-item" onclick="switchTab('profile', this)"><i class="fas fa-user"></i><span>Profile</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyBBuXEgTrEbAkj-BN_VSSYoVDx5e51fw4A",
            authDomain: "achieve-mate.firebaseapp.com",
            projectId: "achieve-mate",
            storageBucket: "achieve-mate.firebasestorage.app",
            messagingSenderId: "209711943902",
            appId: "1:209711943902:web:e8df445f14cc5c9b6eb24f"
        });
        const auth = getAuth(app);
        const db = getFirestore(app);

        // EXPOSE TO GLOBAL WINDOW
        window.fbAuth = auth;
        window.fbDb = db;
        window.createUser = createUserWithEmailAndPassword;
        window.signIn = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('btn-login').style.display='none';
                document.getElementById('user-badge').style.display='flex';
                document.getElementById('btn-logout').style.display='block';
                document.getElementById('p-name').textContent = user.email.split('@')[0];
                document.getElementById('p-email').textContent = user.email;
                
                // Load Cloud Data
                try {
                    const snap = await getDoc(doc(db, "users", user.uid));
                    if(snap.exists()) {
                        window.appData = snap.data();
                        window.saveLocal(); // Sync to local immediately
                        window.refreshUI();
                    }
                } catch(e) { console.error("Load error", e); }
            } else {
                window.currentUser = null;
                document.getElementById('btn-login').style.display='block';
                document.getElementById('user-badge').style.display='none';
                document.getElementById('btn-logout').style.display='none';
                document.getElementById('p-name').textContent = "Guest User";
            }
        });
    </script>

    <script>
        // 1. INITIALIZATION & DATA STRUCTURE
        let appData = {
            xp: 0, level: 1, streak: 0, lastActive: null, isNewUser: true,
            goals: [], playlists: [], history: {}, focusLogs: []
        };
        let focusTimer = null;
        let selectedFocusTime = 25;

        function init() {
            // Load from LocalStorage FIRST (Fastest)
            const local = localStorage.getItem('achieve_v2');
            if (local) { 
                appData = JSON.parse(local); 
            } else {
                // First time launch logic
                setTimeout(() => {
                    if(appData.isNewUser) document.getElementById('welcome-modal').classList.add('active');
                }, 1000);
            }

            // Setup UI
            document.getElementById('date-text').textContent = new Date().toDateString();
            updateGreeting();
            refreshUI();
        }

        function saveLocal() {
            localStorage.setItem('achieve_v2', JSON.stringify(appData));
            // Try cloud save if logged in
            if (window.currentUser && window.fbDb) {
                window.setDoc(window.doc(window.fbDb, "users", window.currentUser.uid), appData).catch(e => console.log("Cloud save bg error"));
            }
        }

        // 2. UI REFRESH ENGINE (The Fix for "Not Rendering")
        function refreshUI() {
            // Update Dashboard
            document.getElementById('lvl-num').textContent = appData.level;
            document.getElementById('xp-num').textContent = appData.xp + ' XP';
            document.getElementById('streak-display').textContent = appData.streak;
            
            // XP Bar
            const nextLvl = appData.level * 500;
            const prevLvl = (appData.level - 1) * 500;
            const pct = Math.max(0, Math.min(100, ((appData.xp - prevLvl) / 500) * 100));
            document.getElementById('lvl-bar').style.width = pct + '%';

            renderGoals();
            renderCourses();
            renderGraph();
            renderBadges();
            renderCalendar();
            renderFocusLogs();
        }

        // 3. FEATURES
        // --- GOALS ---
        function addGoal() {
            const input = document.getElementById('goal-input');
            if(!input.value.trim()) return;
            appData.goals.push({ id: Date.now(), text: input.value, done: false, date: new Date().toDateString() });
            input.value = '';
            saveLocal(); refreshUI();
        }

        function toggleGoal(id) {
            const g = appData.goals.find(x => x.id === id);
            if(g) {
                g.done = !g.done;
                if(g.done) { addXP(20); checkStreak(); } else { addXP(-20); }
                saveLocal(); refreshUI();
            }
        }

        function renderGoals() {
            const today = new Date().toDateString();
            const todaysGoals = appData.goals.filter(g => g.date === today);
            const list = document.getElementById('goals-list');
            
            if(todaysGoals.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">No goals today. Add one!</div>';
                return;
            }

            list.innerHTML = todaysGoals.map(g => `
                <div class="priority-item ${g.done ? 'checked' : ''}" onclick="toggleGoal(${g.id})">
                    <div class="checkbox">${g.done ? '‚úì' : ''}</div>
                    <div class="text">${g.text}</div>
                    <button class="btn-icon-only" style="margin-left:auto;" onclick="deleteGoal(${g.id}, event)">‚úï</button>
                </div>
            `).join('');
        }

        function deleteGoal(id, e) {
            e.stopPropagation();
            appData.goals = appData.goals.filter(g => g.id !== id);
            saveLocal(); refreshUI();
        }

        // --- COURSES ---
        function saveCourse() {
            const name = document.getElementById('c-name').value;
            const rawVideos = document.getElementById('c-videos').value;
            if(!name) return alert("Name required");

            const videos = rawVideos.split('\n').filter(v => v.trim()).map(v => ({ title: v, done: false }));
            appData.playlists.push({ id: Date.now(), name, source: document.getElementById('c-source').value, videos });
            
            document.getElementById('course-modal').classList.remove('active');
            saveLocal(); refreshUI();
        }

        function toggleCourseVideo(pid, vIndex) {
            const pl = appData.playlists.find(p => p.id === pid);
            if(pl && pl.videos[vIndex]) {
                pl.videos[vIndex].done = !pl.videos[vIndex].done;
                if(pl.videos[vIndex].done) { addXP(50); recordHistory('Study'); }
                saveLocal(); refreshUI(); // REAL-TIME RENDER FIX
            }
        }

        function renderCourses() {
            const list = document.getElementById('courses-list');
            if(appData.playlists.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No courses yet.</div>';
                return;
            }
            
            list.innerHTML = appData.playlists.map(pl => {
                const done = pl.videos.filter(v => v.done).length;
                const total = pl.videos.length;
                const pct = total ? (done/total)*100 : 0;
                
                return `
                <div class="course-card">
                    <div class="course-header" onclick="this.nextElementSibling.nextElementSibling.classList.toggle('open')">
                        <div>
                            <div style="font-weight:bold;">${pl.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${pl.source} ‚Ä¢ ${done}/${total}</div>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="course-progress"><div class="course-fill" style="width:${pct}%"></div></div>
                    <div class="video-list">
                        ${pl.videos.map((v, idx) => `
                            <div class="priority-item ${v.done?'checked':''}" onclick="toggleCourseVideo(${pl.id}, ${idx})">
                                <div class="checkbox" style="width:20px; height:20px; font-size:0.8rem;">${v.done?'‚úì':''}</div>
                                <div class="text" style="font-size:0.9rem;">${v.title}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <hr style="border:0; border-bottom:1px solid var(--border); margin:10px 0;">
                `;
            }).join('');
        }

        // --- GRAPH & CALENDAR ---
        function renderGraph() {
            const container = document.getElementById('consistency-graph');
            container.innerHTML = '';
            const days = ['S','M','T','W','T','F','S'];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                // Mock data logic for visual: random height if no data, or real streak data
                const dateStr = d.toLocaleDateString('en-CA');
                const active = appData.history[dateStr] ? 100 : 20;
                
                container.innerHTML += `
                    <div class="graph-bar-wrapper">
                        <div class="graph-bar" style="height:${active}%; background:${active>20 ? 'var(--primary)' : '#334155'}"></div>
                        <div class="graph-day">${days[d.getDay()]}</div>
                    </div>
                `;
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for(let i=1; i<=daysInMonth; i++) {
                const dateStr = new Date(year, month, i).toLocaleDateString('en-CA');
                const hasActivity = appData.history[dateStr];
                const isToday = i === today.getDate();
                
                grid.innerHTML += `
                    <div class="cal-day ${hasActivity ? 'active' : ''}" style="${isToday ? 'border-color:var(--accent)' : ''}">
                        ${i}
                        ${hasActivity ? '<div class="cal-dot"></div>' : ''}
                    </div>
                `;
            }
        }

        // --- BADGES (Full 17 List Reinstated) ---
        const BADGES_DEF = [
            {n:'Starter', t:1, type:'streak'}, {n:'3 Day', t:3, type:'streak'}, {n:'Week Warrior', t:7, type:'streak'},
            {n:'2 Weeks', t:14, type:'streak'}, {n:'Month Master', t:30, type:'streak'}, {n:'50 Days', t:50, type:'streak'},
            {n:'Learner', t:1, type:'xp'}, {n:'Pro', t:1000, type:'xp'}, {n:'Expert', t:5000, type:'xp'},
            {n:'Master', t:10000, type:'xp'}, {n:'Legend', t:50000, type:'xp'}, {n:'Godlike', t:100000, type:'xp'},
            {n:'Focus 1h', t:60, type:'focus'}, {n:'Focus 5h', t:300, type:'focus'}, {n:'Focus 10h', t:600, type:'focus'},
            {n:'Focus 24h', t:1440, type:'focus'}, {n:'Zen Master', t:5000, type:'focus'}
        ];

        function renderBadges() {
            const grid = document.getElementById('badges-grid');
            let earnedCount = 0;
            
            grid.innerHTML = BADGES_DEF.map(b => {
                let val = 0;
                if(b.type === 'streak') val = appData.streak;
                if(b.type === 'xp') val = appData.xp;
                if(b.type === 'focus') val = (appData.totalFocusTime || 0);
                
                const unlocked = val >= b.t;
                if(unlocked) earnedCount++;
                
                return `
                    <div class="ach-item ${unlocked ? 'unlocked' : ''}">
                        <div class="ach-icon">${unlocked ? 'üèÜ' : 'üîí'}</div>
                        <div class="ach-name">${b.n}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('badge-count').textContent = `${earnedCount}/${BADGES_DEF.length}`;
        }

        // --- FOCUS MODE ---
        function setFocusTime(m) {
            selectedFocusTime = m;
            document.getElementById('focus-input').value = `${m} Minutes`;
        }

        function startFocus() {
            const overlay = document.getElementById('focus-overlay');
            const taskName = document.getElementById('focus-input').value || "Deep Work";
            document.getElementById('focus-task-name').textContent = taskName;
            overlay.classList.add('active');
            
            let seconds = selectedFocusTime * 60;
            
            focusTimer = setInterval(() => {
                seconds--;
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                document.getElementById('focus-timer-display').textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
                
                if (seconds <= 0) {
                    clearInterval(focusTimer);
                    alert("Session Complete! + XP");
                    addXP(selectedFocusTime * 5);
                    stopFocus();
                    // Log session
                    appData.focusLogs.unshift({ date: new Date().toLocaleTimeString(), duration: selectedFocusTime });
                    appData.totalFocusTime = (appData.totalFocusTime || 0) + selectedFocusTime;
                    saveLocal(); refreshUI();
                }
            }, 1000);
        }

        function stopFocus() {
            clearInterval(focusTimer);
            document.getElementById('focus-overlay').classList.remove('active');
        }

        function renderFocusLogs() {
            const div = document.getElementById('focus-logs');
            if(appData.focusLogs.length === 0) return;
            div.innerHTML = appData.focusLogs.slice(0,5).map(l => `<div>Session: ${l.duration}m at ${l.date}</div>`).join('');
        }

        // --- AUTH & UTILS ---
        function toggleAuth(show) {
            const el = document.getElementById('auth-modal');
            if(show) el.classList.add('active'); else el.classList.remove('active');
        }

        function handleLogin() {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            if(!e || !p) return alert("Enter details");
            
            window.signIn(window.fbAuth, e, p)
                .then(() => { toggleAuth(false); showToast("Logged In!"); })
                .catch(err => alert("Login Error: " + err.message));
        }

        function handleSignup() {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            window.createUser(window.fbAuth, e, p)
                .then(() => { toggleAuth(false); alert("Account Created! You are logged in."); })
                .catch(err => alert("Signup Error: " + err.message));
        }

        function handleLogout() {
            window.signOut(window.fbAuth).then(() => window.location.reload());
        }

        function switchTab(viewId, btnElement) {
            // Hide all
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById('view-' + viewId).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
            
            refreshUI();
        }

        function addXP(amount) {
            appData.xp += amount;
            if(appData.xp < 0) appData.xp = 0;
            appData.level = Math.floor(appData.xp / 500) + 1;
        }

        function checkStreak() {
            const today = new Date().toLocaleDateString('en-CA');
            if(appData.lastActive !== today) {
                appData.streak++;
                appData.lastActive = today;
                recordHistory('Active');
            }
        }

        function recordHistory(type) {
            const today = new Date().toLocaleDateString('en-CA');
            appData.history[today] = type;
        }

        function updateGreeting() {
            const h = new Date().getHours();
            const t = h < 12 ? "Good Morning" : h < 18 ? "Good Afternoon" : "Good Evening";
            document.getElementById('greet-text').textContent = t;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.display='block';
            setTimeout(()=>t.style.display='none', 3000);
        }

        function resetData() {
            if(confirm("Are you sure? This deletes everything.")) {
                localStorage.clear();
                window.location.reload();
            }
        }

        function closeWelcome() {
            document.getElementById('welcome-modal').classList.remove('active');
            appData.isNewUser = false;
            saveLocal();
        }

        // START APP
        init();
    </script>
</body>
</html>